# Excel 匯入/匯出規格說明書

## 概述

此功能允許使用者透過 Excel 檔案批次匯入和匯出交易資料。支援下載範本、匯出既有資料以及匯入新資料。

## 檔案結構與欄位

基本結構請參考 `transactionColumns`。
Excel 檔案應包含一個可見的資料工作表（Sheet）以及一個隱藏的 `_Options` 工作表作為驗證來源。

### 欄位定義

| 標題         |  必填  | 格式         | 驗證與備註                                                                    |
| :----------- | :----: | :----------- | :---------------------------------------------------------------------------- |
| **日期**     |   是   | `yyyy-mm-dd` |                                                                               |
| **時間**     |   是   | `HH:mm:ss`   |                                                                               |
| **類型**     |   是   | Enum         | 選項來自 `RootType` (收入、支出、轉帳)                                        |
| **金額**     |   是   | 數字         | 必須為非負數 (>= 0)                                                           |
| **帳戶**     |   是   | 字串         | 必須符合 `_Options` 中的選項 (使用者自定義帳戶)                               |
| **目標帳戶** | 條件式 | 字串         | 當類型為 `TRANSFER` (轉帳) 時必填；否則應為禁用或 Null。必須符合 `_Options`。 |
| **分類**     |   是   | 字串         | 格式：`主分類-子分類` 或 `主分類` (若無子分類)。必須符合 `_Options`。         |
| **發票**     |   否   | 字串         | 選填字串                                                                      |
| **描述**     |   否   | 字串         | 選填字串                                                                      |

> **UI 備註**：必填欄位的**標題**應有視覺標示（例如：淡粉紅色背景）。

### 隱藏工作表：`_Options`

- 包含 **帳戶** 和 **分類** 的有效選項。
- 此工作表依據每位使用者的設定動態產生。
- **分類**：應列出完整路徑字串（例如："飲食-晚餐"）。後端需負責將此字串對映至特定的 SubCategory ID（若無子分類則為主分類 ID）。

## 功能需求

### 1. 下載範本 (Download Template)

- 產生包含定義欄位的 Excel 檔案。
- 包含填入當前使用者帳戶與分類的隱藏 `_Options` 工作表。
- **預填資料**：範本中應包含一筆預設的範例資料，讓使用者了解預期格式。

### 2. 匯出 Excel (Export Excel)

- 匯出當前使用者的所有交易紀錄。
- **結構**：與範本相同。
- **空狀態**：若使用者無任何交易紀錄，回傳一個**僅包含標題列**（及隱藏選項）的有效 Excel 檔案。不應禁用此功能，讓使用者能查看格式。

### 3. 匯入 Excel (Import Excel)

- **行為**：**僅新增 (Add Only)**。上傳檔案中的所有有效列都將視為**新交易**。
- **儲存機制**：所有上傳的 Excel 檔案必須存放到 **Azure Blob Storage**。
- **格式**：使用者通常會修改下載的範本或匯出檔後重新上傳。
- **錯誤處理 (Error Excel 機制)**：
  - 若有資料驗證失敗，系統需產生一份 "Error Excel" 供使用者下載。
  - **結構變更**：
    - **插入第一欄**："錯誤訊息" (列出該列的具體驗證錯誤)。
    - **位移**：原始欄位向右移動一格。
  - **視覺樣式**：錯誤的儲存格應以 **亮黃色背景** 標示。
  - **重新上傳 (Re-upload)**：系統需能識別此 "Error Excel" 格式（透過檢查第一欄標題）。若偵測到錯誤欄位，系統應**忽略第一欄**並處理其餘資料作為標準匯入。
  - **部分匯入 (Partial Success)**:
    - 系統僅會退回 **驗證失敗** 的列 (Error Excel)。
    - **驗證成功** 的列會直接寫入資料庫並 Commit。
    - 使用者只需修正 Error Excel 中的資料後再次上傳，不需要重新上傳整份原始檔 (避免重複匯入)。

## 邏輯細節

- **目標帳戶 (Target Account)**：
  - **驗證**：僅在 `類型 == 操作` 時允許填寫。
  - **UI/檔案限制**：非轉帳類型時，此欄位應鎖定或嚴格驗證為空值/Null。
- **分類解析 (Category Parsing)**：
  - 輸入："主分類-子分類" 或 "主分類"。
  - 邏輯：依分隔符號拆分。找到 `MainCategory`。若有子分類部分，則在該主分類下尋找 `SubCategory`。
  - 儲存：儲存最深層的 ID (若有子分類則存 SubCategory ID，否則存 MainCategory ID)。

---

## 測試策略

### 1. 正向測試案例 (Positive Test Cases)

- **匯入有效資料**：上傳包含收入、支出、轉帳的有效檔案。驗證資料庫是否正確建立紀錄。
- **Azure Blob 儲存**：驗證上傳的檔案是否成功寫入 Azure Blob。
- **分類對映**：
  - 輸入 "主分類-子分類" -> 應對映至 SubCategory ID。
  - 輸入 "主分類" -> 應對映至 MainCategory ID。
- **轉帳邏輯**："轉帳" 類型且包含帳戶與目標帳戶，應正確匯入。
- **重新上傳修正後的錯誤檔**：上傳模擬 "Error Excel" 結構的檔案（第一欄為錯誤訊息），確保後端忽略第一欄並成功匯入資料。

### 2. 反向測試案例 (Negative Test Cases)

- **必填欄位**：留空日期、金額、類型、帳戶或分類 -> 預期回傳 Error Excel。
- **無效資料類型**：
  - 金額 = -100 (負數)。
  - 金額 = "abc" (非數字)。
  - 日期 = "2023/13/45" (無效日期)。
- **無效限制**：
  - 類型 = "支出" 但填寫了 "目標帳戶"。
  - 類型 = "轉帳" 但缺少 "目標帳戶"。
- **無效關聯**：
  - 帳戶名稱不在使用者的選項清單中。
  - 分類 "飲食-岩漿"，其中 "岩漿" 不存在於 "飲食" 分類下。

### 3. 邊緣案例 (Edge Cases)

- **空檔案**：上傳僅有標題列的檔案。
- **無交易匯出**：無交易紀錄的使用者執行匯出（應得到僅有標題的檔案）。
- **混合有效性**：檔案中包含 5 筆有效與 5 筆無效資料 -> (依據 Error Excel 機制，通常會回傳包含錯誤標示的檔案供修正，或者驗證失敗即全數拒絕並回傳錯誤檔)。
