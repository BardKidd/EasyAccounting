# Turborepo å®Œæ•´èªªæ˜æ–‡ä»¶

## ç›®éŒ„

1. [ä»€éº¼æ˜¯ Turborepo](#ä»€éº¼æ˜¯-turborepo)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
3. [åº•å±¤é‹ä½œæ©Ÿåˆ¶](#åº•å±¤é‹ä½œæ©Ÿåˆ¶)
4. [å¥—ä»¶ç®¡ç†å™¨é¸æ“‡](#å¥—ä»¶ç®¡ç†å™¨é¸æ“‡)
5. [åŸºç¤è¨­å®š](#åŸºç¤è¨­å®š)
6. [é‹ä½œæ–¹å¼](#é‹ä½œæ–¹å¼)
7. [é€²éšåŠŸèƒ½](#é€²éšåŠŸèƒ½)

---

## ä»€éº¼æ˜¯ Turborepo

Turborepo æ˜¯ä¸€å€‹å°ˆç‚º JavaScript å’Œ TypeScript å°ˆæ¡ˆè¨­è¨ˆçš„**é«˜æ•ˆèƒ½å»ºç½®ç³»çµ±**,ç‰¹åˆ¥é‡å° **Monorepo** (å–®ä¸€å„²å­˜åº«) æ¶æ§‹é€²è¡Œæœ€ä½³åŒ–ã€‚å®ƒç”± Vercel åœ˜éšŠé–‹ç™¼,ç›®æ¨™æ˜¯è§£æ±ºå¤§å‹ Monorepo å°ˆæ¡ˆåœ¨å»ºç½®é€Ÿåº¦å’Œé–‹ç™¼é«”é©—ä¸Šçš„æŒ‘æˆ°ã€‚

### ä¸»è¦ç‰¹è‰²

- ğŸš€ **æ¥µè‡´å¿«é€Ÿ**: é€éæ™ºæ…§å¿«å–å’Œå¹³è¡ŒåŸ·è¡Œ,å¤§å¹…æ¸›å°‘å»ºç½®æ™‚é–“
- ğŸ”„ **å¢é‡å»ºç½®**: åªé‡æ–°å»ºç½®æœ‰è®Šæ›´çš„éƒ¨åˆ†
- ğŸŒ **é ç«¯å¿«å–**: åœ˜éšŠæˆå“¡å’Œ CI/CD ç’°å¢ƒå…±äº«å»ºç½®å¿«å–
- ğŸ“¦ **é›¶åŸ·è¡Œæ™‚é–‹éŠ·**: ä¸æœƒå¹²æ“¾åŸ·è¡Œæ™‚ç¨‹å¼ç¢¼æˆ–ä¿®æ”¹ sourcemap
- ğŸ”§ **æ˜“æ–¼æ•´åˆ**: èˆ‡ç¾æœ‰çš„ npmã€yarnã€pnpm å°ˆæ¡ˆç„¡ç¸«æ•´åˆ

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. Monorepo æ¶æ§‹

Turborepo å»ºç«‹åœ¨ JavaScript å¥—ä»¶ç®¡ç†å™¨çš„ workspace åŠŸèƒ½ä¹‹ä¸Š,å…¸å‹çš„å°ˆæ¡ˆçµæ§‹å¦‚ä¸‹:

```
my-monorepo/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ web/          # Next.js æ‡‰ç”¨ç¨‹å¼
â”‚   â””â”€â”€ mobile/       # React Native æ‡‰ç”¨ç¨‹å¼
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ ui/           # å…±ç”¨ UI å…ƒä»¶åº«
â”‚   â”œâ”€â”€ utils/        # å…±ç”¨å·¥å…·å‡½å¼
â”‚   â””â”€â”€ tsconfig/     # å…±ç”¨ TypeScript è¨­å®š
â”œâ”€â”€ package.json      # æ ¹ç›®éŒ„ package.json
â”œâ”€â”€ turbo.json        # Turborepo è¨­å®šæª”
â””â”€â”€ pnpm-workspace.yaml
```

### 2. ä»»å‹™ (Tasks)

ä»»å‹™æ˜¯æŒ‡åœ¨ `package.json` ä¸­å®šç¾©çš„ scripts,ä¾‹å¦‚:

- `build`: å»ºç½®å°ˆæ¡ˆ
- `test`: åŸ·è¡Œæ¸¬è©¦
- `lint`: ç¨‹å¼ç¢¼æª¢æŸ¥
- `dev`: é–‹ç™¼ä¼ºæœå™¨

### 3. ä¾è³´åœ– (Dependency Graph)

Turborepo æœƒè‡ªå‹•åˆ†æå°ˆæ¡ˆä¹‹é–“çš„ä¾è³´é—œä¿‚,å»ºç«‹ä¸€å€‹ä¾è³´åœ–ã€‚é€™è®“ Turborepo èƒ½å¤ :

- ä»¥æ­£ç¢ºçš„é †åºåŸ·è¡Œä»»å‹™
- è­˜åˆ¥å“ªäº›å°ˆæ¡ˆéœ€è¦é‡æ–°å»ºç½®
- æœ€å¤§åŒ–å¹³è¡ŒåŸ·è¡Œçš„æ©Ÿæœƒ

### 4. å¿«å– (Caching)

Turborepo çš„æ ¸å¿ƒå“²å­¸æ˜¯:**æ°¸é ä¸è¦é‡è¤‡è¨ˆç®—å·²ç¶“å®Œæˆçš„å·¥ä½œ**ã€‚

---

## åº•å±¤é‹ä½œæ©Ÿåˆ¶

### 1. å¿«å–æŒ‡ç´‹ (Cache Fingerprinting)

Turborepo ç‚ºæ¯å€‹ä»»å‹™åŸ·è¡Œç”Ÿæˆä¸€å€‹å”¯ä¸€çš„ã€ŒæŒ‡ç´‹ã€(hash),é€™å€‹æŒ‡ç´‹ç”±ä»¥ä¸‹å› ç´ çµ„æˆ:

#### æª”æ¡ˆå…§å®¹

- ä½¿ç”¨**å…§å®¹æ„ŸçŸ¥æ¼”ç®—æ³•**å°æª”æ¡ˆå…§å®¹é€²è¡Œé›œæ¹Š
- å¿½ç•¥æª”æ¡ˆçš„æ™‚é–“æˆ³è¨˜ç­‰ç„¡é—œçš„ä¸­ç¹¼è³‡æ–™
- åªæœ‰ç•¶æª”æ¡ˆçš„**å¯¦éš›å…§å®¹**æ”¹è®Šæ™‚,æ‰æœƒè§¸ç™¼é‡æ–°åŸ·è¡Œ

#### ç’°å¢ƒè®Šæ•¸

- åœ¨ `turbo.json` ä¸­æŒ‡å®šçš„ç’°å¢ƒè®Šæ•¸æœƒå½±éŸ¿å¿«å–
- ç’°å¢ƒè®Šæ•¸æ”¹è®Šæœƒå°è‡´å¿«å–å¤±æ•ˆ

#### ä¾è³´é—œä¿‚

- `package.json` å’Œ lock æª”æ¡ˆçš„å…§å®¹
- å°ˆæ¡ˆä¹‹é–“çš„ä¾è³´é—œä¿‚

#### ä»»å‹™è¨­å®š

- `turbo.json` ä¸­çš„ä»»å‹™è¨­å®š
- ä»»å‹™çš„ `inputs` å’Œ `outputs` å®šç¾©

### 2. å¿«å–å‘½ä¸­èˆ‡æœªå‘½ä¸­

```mermaid
flowchart TD
    A[åŸ·è¡Œ turbo run build] --> B[è¨ˆç®—ä»»å‹™æŒ‡ç´‹]
    B --> C{å¿«å–ä¸­æ˜¯å¦å­˜åœ¨?}
    C -->|æ˜¯| D[å¿«å–å‘½ä¸­ Cache Hit]
    C -->|å¦| E[å¿«å–æœªå‘½ä¸­ Cache Miss]
    D --> F[å¾å¿«å–é‚„åŸè¼¸å‡ºæª”æ¡ˆ]
    E --> G[åŸ·è¡Œä»»å‹™]
    G --> H[å°‡è¼¸å‡ºå„²å­˜åˆ°å¿«å–]
    F --> I[ä»»å‹™å®Œæˆ]
    H --> I
```

**å¿«å–å‘½ä¸­ (Cache Hit)**:

- Turborepo æ‰¾åˆ°åŒ¹é…çš„æŒ‡ç´‹
- ç›´æ¥å¾å¿«å–é‚„åŸå…ˆå‰å„²å­˜çš„è¼¸å‡ºæª”æ¡ˆ
- è·³éä»»å‹™åŸ·è¡Œ,ç¯€çœå¤§é‡æ™‚é–“

**å¿«å–æœªå‘½ä¸­ (Cache Miss)**:

- æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„æŒ‡ç´‹
- æ­£å¸¸åŸ·è¡Œä»»å‹™
- å°‡è¼¸å‡ºæª”æ¡ˆå„²å­˜åˆ°å¿«å–ä¾›æœªä¾†ä½¿ç”¨

### 3. æœ¬åœ°å¿«å– vs é ç«¯å¿«å–

#### æœ¬åœ°å¿«å– (Local Cache)

- é è¨­å•Ÿç”¨
- å¿«å–å„²å­˜åœ¨æœ¬åœ°æª”æ¡ˆç³»çµ± (`.turbo/cache/`)
- åªå°å–®ä¸€é–‹ç™¼è€…çš„æ©Ÿå™¨æœ‰æ•ˆ

#### é ç«¯å¿«å– (Remote Cache)

- éœ€è¦é¡å¤–è¨­å®š
- å¿«å–å„²å­˜åœ¨é›²ç«¯ä¼ºæœå™¨
- æ•´å€‹åœ˜éšŠå’Œ CI/CD ç’°å¢ƒå…±äº«å¿«å–
- **å·¨å¤§å„ªå‹¢**: CI ä¼ºæœå™¨å¯ä»¥ä½¿ç”¨é–‹ç™¼è€…æœ¬åœ°å»ºç½®çš„å¿«å–,åä¹‹äº¦ç„¶

```mermaid
flowchart LR
    A[é–‹ç™¼è€… A] -->|ä¸Šå‚³å¿«å–| C[é ç«¯å¿«å–ä¼ºæœå™¨]
    B[é–‹ç™¼è€… B] -->|ä¸‹è¼‰å¿«å–| C
    D[CI/CD] -->|ä¸‹è¼‰å¿«å–| C
    A -->|ä¸‹è¼‰å¿«å–| C
```

### 4. å¹³è¡ŒåŸ·è¡Œ (Parallel Execution)

Turborepo æœƒåˆ†æä»»å‹™ä¹‹é–“çš„ä¾è³´é—œä¿‚,ä¸¦ç›¡å¯èƒ½å¹³è¡ŒåŸ·è¡Œç¨ç«‹çš„ä»»å‹™:

```mermaid
graph TD
    A[packages/ui:build] --> C[apps/web:build]
    B[packages/utils:build] --> C
    B --> D[apps/mobile:build]
    A --> D
```

åœ¨ä¸Šåœ–ä¸­:

- `packages/ui:build` å’Œ `packages/utils:build` å¯ä»¥**åŒæ™‚åŸ·è¡Œ**
- `apps/web:build` å’Œ `apps/mobile:build` å¿…é ˆç­‰å¾…ä¾è³´å®Œæˆå¾Œæ‰èƒ½åŸ·è¡Œ
- ä½† `apps/web:build` å’Œ `apps/mobile:build` ä¹‹é–“å¯ä»¥**å¹³è¡ŒåŸ·è¡Œ**

### 5. å¢é‡å»ºç½® (Incremental Builds)

Turborepo åªæœƒé‡æ–°å»ºç½®æœ‰è®Šæ›´çš„éƒ¨åˆ†:

1. **è®Šæ›´åµæ¸¬**: é€éæª”æ¡ˆå…§å®¹é›œæ¹Šåµæ¸¬è®Šæ›´
2. **å½±éŸ¿åˆ†æ**: åˆ†æå“ªäº›å¥—ä»¶å—åˆ°è®Šæ›´å½±éŸ¿
3. **é¸æ“‡æ€§åŸ·è¡Œ**: åªåŸ·è¡Œå—å½±éŸ¿å¥—ä»¶çš„ä»»å‹™

---

## å¥—ä»¶ç®¡ç†å™¨é¸æ“‡

### Turborepo æ”¯æ´çš„å¥—ä»¶ç®¡ç†å™¨

Turborepo **ä¸¦ä¸å¼·åˆ¶ä½¿ç”¨ç‰¹å®šçš„å¥—ä»¶ç®¡ç†å™¨**,å®ƒåŒæ™‚æ”¯æ´:

- **npm** - Node.js é è¨­å¥—ä»¶ç®¡ç†å™¨
- **yarn** - Facebook é–‹ç™¼çš„å¥—ä»¶ç®¡ç†å™¨
- **pnpm** - é«˜æ•ˆèƒ½çš„å¥—ä»¶ç®¡ç†å™¨

Turborepo æœƒè‡ªå‹•åµæ¸¬ä½ ä½¿ç”¨çš„å¥—ä»¶ç®¡ç†å™¨,ç„¡éœ€é¡å¤–è¨­å®šã€‚

### ç‚ºä»€éº¼æ¨è–¦ pnpmï¼Ÿ

é›–ç„¶ä¸‰ç¨®å¥—ä»¶ç®¡ç†å™¨éƒ½å¯ä»¥ä½¿ç”¨,ä½† **pnpm åœ¨ Monorepo å ´æ™¯ä¸‹æœ‰é¡¯è‘—å„ªå‹¢**:

#### 1. æ¥µè‡´çš„å®‰è£é€Ÿåº¦ âš¡

æ ¹æ“š 2025 å¹´çš„æ•ˆèƒ½æ¸¬è©¦:

- **æ¯” npm å¿« 65%**
- åœ¨å¤§å‹ Monorepo ä¸­,æ¸…ç©ºå¿«å–å¾Œçš„å®‰è£é€Ÿåº¦æ˜¯ npm çš„ **3 å€**
- å³ä½¿æœ‰å¿«å–,ä¹Ÿæ¯” Yarn æ›´å¿«

#### 2. é©šäººçš„ç£ç¢Ÿç©ºé–“ç¯€çœ ğŸ’¾

**npm/yarn çš„åšæ³•** (é‡è¤‡å„²å­˜):

```
my-monorepo/
â”œâ”€â”€ apps/web/node_modules/react (5MB)
â”œâ”€â”€ apps/mobile/node_modules/react (5MB)
â””â”€â”€ packages/ui/node_modules/react (5MB)
ç¸½å…±ï¼š15MB âŒ æµªè²» 10MB
```

**pnpm çš„åšæ³•** (ç¬¦è™Ÿé€£çµ):

```
~/.pnpm-store/
â””â”€â”€ react@18.2.0 (5MB) â† åªå„²å­˜ä¸€æ¬¡

my-monorepo/
â”œâ”€â”€ apps/web/node_modules/react â†’ symlink
â”œâ”€â”€ apps/mobile/node_modules/react â†’ symlink
â””â”€â”€ packages/ui/node_modules/react â†’ symlink
ç¸½å…±ï¼š5MB âœ… ç¯€çœ 67% ç©ºé–“
```

**å¯¦éš›æ¡ˆä¾‹**:

- 10 å€‹å¥—ä»¶çš„ Monorepo
  - npm: ~1.2 GB
  - pnpm: ~300 MB

#### 3. åš´æ ¼çš„ä¾è³´éš”é›¢ ğŸ”’

é€™æ˜¯ pnpm æœ€é‡è¦çš„å„ªå‹¢ä¹‹ä¸€ï¼

**ä»€éº¼æ˜¯ã€Œå¹½éˆä¾è³´ã€(Phantom Dependencies)ï¼Ÿ**

```javascript
// apps/web/package.json
{
  "dependencies": {
    "next": "^14.0.0"  // Next.js å…§éƒ¨ä¾è³´ react
  }
}

// åœ¨ä½ çš„ç¨‹å¼ç¢¼ä¸­
import React from 'react'
```

**ä¸åŒå¥—ä»¶ç®¡ç†å™¨çš„è¡Œç‚º**:

| å¥—ä»¶ç®¡ç†å™¨   | è¡Œç‚º        | å•é¡Œ              |
| ------------ | ----------- | ----------------- |
| **npm/yarn** | âœ… å¯ä»¥é‹ä½œ | âŒ éš±è—çš„ä¾è³´é¢¨éšª |
| **pnpm**     | âŒ æœƒå ±éŒ¯   | âœ… å¼·åˆ¶æ˜ç¢ºå®£å‘Š   |

**ç‚ºä»€éº¼é€™å¾ˆé‡è¦ï¼Ÿ**

ä½¿ç”¨ npm/yarn æ™‚:

- ä½ å¯ä»¥ä½¿ç”¨æ²’æœ‰æ˜ç¢ºå®£å‘Šçš„ä¾è³´ï¼ˆå› ç‚ºå®ƒå€‘è¢«ã€Œæå‡ã€åˆ°æ ¹ç›®éŒ„ï¼‰
- ç•¶å…¶ä»–å¥—ä»¶ç§»é™¤è©²ä¾è³´æ™‚,ä½ çš„ç¨‹å¼ç¢¼æœƒçªç„¶å£æ‰
- åœ¨ Docker å»ºç½®æ™‚å¯èƒ½å‡ºç¾ã€Œæ‰¾ä¸åˆ°æ¨¡çµ„ã€çš„éŒ¯èª¤

ä½¿ç”¨ pnpm æ™‚:

- **å¼·åˆ¶ä½ æ˜ç¢ºå®£å‘Šæ‰€æœ‰ä¾è³´**
- æ¯å€‹å¥—ä»¶åªèƒ½å­˜å–è‡ªå·± `package.json` ä¸­å®£å‘Šçš„ä¾è³´
- æ›´å¯é ã€æ›´å¯é æ¸¬çš„å»ºç½®éç¨‹

#### 4. æ›´ä¹¾æ·¨çš„ Docker å»ºç½® ğŸ³

```dockerfile
FROM node:20-alpine

# pnpm ç¢ºä¿æ¯å€‹ app æ˜ç¢ºå®£å‘Šä¾è³´
# ä¸æœƒæ„å¤–åŒ…å«ä¸éœ€è¦çš„å¥—ä»¶
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

# ç”¢ç”Ÿçš„ Docker image æ›´å°ã€æ›´å¿«
```

**å„ªå‹¢**:

- æ²’æœ‰å¹½éˆä¾è³´,Docker å»ºç½®æ›´å¯é 
- åªåŒ…å«æ˜ç¢ºå®£å‘Šçš„ä¾è³´,image æ›´å°
- æ¸›å°‘ã€Œæœ¬åœ°å¯ä»¥é‹ä½œ,Docker å»å¤±æ•—ã€çš„å•é¡Œ

#### 5. å®Œç¾æ­é… Turborepo ğŸš€

```bash
# Turborepo çš„å¿«å– + pnpm çš„é€Ÿåº¦ = æ¥µè‡´æ•ˆèƒ½
turbo run build

# ç¬¬ä¸€æ¬¡åŸ·è¡Œ:
# - pnpm å¿«é€Ÿå®‰è£ä¾è³´
# - Turborepo åŸ·è¡Œå»ºç½®ä¸¦å¿«å–

# ç¬¬äºŒæ¬¡åŸ·è¡Œï¼ˆæ²’æœ‰è®Šæ›´ï¼‰:
# - pnpm å¾ symlink ç¬é–“å®Œæˆ
# - Turborepo å¾å¿«å–é‚„åŸ
# ç¸½æ™‚é–“ï¼šå¹¾ä¹ç‚º 0ï¼
```

### å¥—ä»¶ç®¡ç†å™¨æ•ˆèƒ½æ¯”è¼ƒ (2025)

| ç‰¹æ€§              | npm             | yarn    | pnpm        |
| ----------------- | --------------- | ------- | ----------- |
| **å®‰è£é€Ÿåº¦**      | æ…¢              | ä¸­ç­‰    | â­ **æœ€å¿«** |
| **ç£ç¢Ÿç©ºé–“**      | å¤§é‡é‡è¤‡        | æœ‰æ”¹å–„  | â­ **æœ€çœ** |
| **ä¾è³´éš”é›¢**      | âŒ å¯¬é¬†         | âŒ å¯¬é¬† | â­ **åš´æ ¼** |
| **Monorepo æ”¯æ´** | åŸºæœ¬            | è‰¯å¥½    | â­ **å„ªç§€** |
| **å­¸ç¿’æ›²ç·š**      | ç°¡å–®            | ç°¡å–®    | ç°¡å–®        |
| **ç”Ÿæ…‹ç³»çµ±**      | â­ æœ€å¤§         | å¤§      | æˆé•·ä¸­      |
| **é è¨­å®‰è£**      | â­ Node.js å…§å»º | éœ€å®‰è£  | éœ€å®‰è£      |

### å¦‚ä½•é¸æ“‡ï¼Ÿ

#### âœ… ä½¿ç”¨ pnpm å¦‚æœ:

- ä½ åœ¨é–‹ç™¼ Monorepoï¼ˆå¼·çƒˆæ¨è–¦ï¼‰
- ä½ é‡è¦–å»ºç½®é€Ÿåº¦å’Œç£ç¢Ÿç©ºé–“
- ä½ æƒ³è¦æ›´å¯é çš„ä¾è³´ç®¡ç†
- ä½ éœ€è¦åœ¨ Docker ä¸­å»ºç½®
- ä½ æƒ³è¦æœ€ä½³çš„é–‹ç™¼é«”é©—

#### âœ… ä½¿ç”¨ npm å¦‚æœ:

- ä½ çš„å°ˆæ¡ˆå¾ˆå°ä¸”ç°¡å–®
- ä½ æƒ³è¦æœ€å¤§çš„ç›¸å®¹æ€§
- ä½ ä¸æƒ³å®‰è£é¡å¤–å·¥å…·
- ä½ çš„åœ˜éšŠä¸ç†Ÿæ‚‰å…¶ä»–å·¥å…·

#### âœ… ä½¿ç”¨ yarn å¦‚æœ:

- ä½ å·²ç¶“åœ¨ä½¿ç”¨ yarn
- ä½ éœ€è¦ Plug'n'Play (PnP) åŠŸèƒ½
- ä½ çš„åœ˜éšŠç†Ÿæ‚‰ yarn å·¥ä½œæµç¨‹

### pnpm å¿«é€Ÿä¸Šæ‰‹

#### å®‰è£ pnpm

```bash
# ä½¿ç”¨ npm å®‰è£
npm install -g pnpm

# ä½¿ç”¨ Homebrew (macOS)
brew install pnpm

# ä½¿ç”¨ Corepack (Node.js 16.13+)
corepack enable
corepack prepare pnpm@latest --activate
```

#### åŸºæœ¬æŒ‡ä»¤å°ç…§

| npm                   | pnpm                 | èªªæ˜     |
| --------------------- | -------------------- | -------- |
| `npm install`         | `pnpm install`       | å®‰è£ä¾è³´ |
| `npm install <pkg>`   | `pnpm add <pkg>`     | æ–°å¢å¥—ä»¶ |
| `npm uninstall <pkg>` | `pnpm remove <pkg>`  | ç§»é™¤å¥—ä»¶ |
| `npm run <script>`    | `pnpm <script>`      | åŸ·è¡Œè…³æœ¬ |
| `npx <command>`       | `pnpm dlx <command>` | åŸ·è¡Œå¥—ä»¶ |

#### å»ºç«‹ pnpm workspace

åœ¨æ ¹ç›®éŒ„å»ºç«‹ `pnpm-workspace.yaml`:

```yaml
packages:
  - 'apps/*'
  - 'packages/*'
```

### åº•å±¤é‹ä½œåŸç†

#### pnpm çš„å…§å®¹å°‹å€å„²å­˜ (Content-Addressable Store)

```mermaid
flowchart TD
    A[å®‰è£ react@18.2.0] --> B{æª¢æŸ¥å…¨åŸŸå„²å­˜}
    B -->|ä¸å­˜åœ¨| C[ä¸‹è¼‰åˆ° ~/.pnpm-store]
    B -->|å·²å­˜åœ¨| D[è·³éä¸‹è¼‰]
    C --> E[å»ºç«‹ç¡¬é€£çµåˆ° node_modules]
    D --> E
    E --> F[å»ºç«‹ç¬¦è™Ÿé€£çµä¾›å¥—ä»¶ä½¿ç”¨]
```

**é—œéµæ¦‚å¿µ**:

1. **å…¨åŸŸå„²å­˜**: æ‰€æœ‰å¥—ä»¶åªå„²å­˜ä¸€æ¬¡åœ¨ `~/.pnpm-store`
2. **ç¡¬é€£çµ (Hard Link)**: å°‡å¥—ä»¶é€£çµåˆ°å°ˆæ¡ˆçš„ `node_modules/.pnpm`
3. **ç¬¦è™Ÿé€£çµ (Symlink)**: å¾ `node_modules/<package>` æŒ‡å‘ `.pnpm` ä¸­çš„å¯¦éš›æª”æ¡ˆ

**å„ªå‹¢**:

- ä¸åŒå°ˆæ¡ˆå…±äº«ç›¸åŒç‰ˆæœ¬çš„å¥—ä»¶
- ä¸ä½”ç”¨é¡å¤–ç£ç¢Ÿç©ºé–“
- å®‰è£é€Ÿåº¦æ¥µå¿«

---

## åŸºç¤è¨­å®š

### 1. å®‰è£ Turborepo

#### å»ºç«‹æ–°å°ˆæ¡ˆ

```bash
npx create-turbo@latest
```

#### åœ¨ç¾æœ‰å°ˆæ¡ˆä¸­å®‰è£

```bash
npm install turbo --save-dev
# æˆ–
pnpm add turbo -D
# æˆ–
yarn add turbo -D
```

### 2. è¨­å®š Workspace

åœ¨æ ¹ç›®éŒ„çš„ `package.json` ä¸­è¨­å®š workspaces:

```json
{
  "name": "my-monorepo",
  "private": true,
  "workspaces": ["apps/*", "packages/*"],
  "scripts": {
    "build": "turbo run build",
    "dev": "turbo run dev",
    "test": "turbo run test",
    "lint": "turbo run lint"
  },
  "devDependencies": {
    "turbo": "latest"
  }
}
```

### 3. å»ºç«‹ turbo.json

åœ¨æ ¹ç›®éŒ„å»ºç«‹ `turbo.json` è¨­å®šæª”:

```json
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": [".env", "tsconfig.json"],
  "globalEnv": ["NODE_ENV"],
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**", ".next/**", "!.next/cache/**"]
    },
    "test": {
      "dependsOn": ["build"],
      "outputs": ["coverage/**"],
      "inputs": ["src/**/*.ts", "src/**/*.tsx", "test/**/*.ts"]
    },
    "lint": {
      "dependsOn": ["^build"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    }
  }
}
```

### 4. turbo.json è¨­å®šè©³è§£

#### é ‚å±¤å±¬æ€§

**`$schema`**

- æä¾› IDE è‡ªå‹•å®Œæˆå’Œé©—è­‰æ”¯æ´
- é€£çµåˆ° Turborepo çš„ JSON schema

**`globalDependencies`**

- å…¨åŸŸä¾è³´æª”æ¡ˆçš„ glob æ¨¡å¼é™£åˆ—
- é€™äº›æª”æ¡ˆè®Šæ›´æ™‚,æœƒä½¿æ‰€æœ‰ä»»å‹™çš„å¿«å–å¤±æ•ˆ
- é è¨­åŒ…å«æ ¹ç›®éŒ„çš„ `package.json` å’Œ lock æª”æ¡ˆ

**`globalEnv`**

- å½±éŸ¿æ‰€æœ‰ä»»å‹™é›œæ¹Šçš„ç’°å¢ƒè®Šæ•¸æ¸…å–®
- é€™äº›ç’°å¢ƒè®Šæ•¸æ”¹è®Šæœƒå°è‡´æ‰€æœ‰ä»»å‹™å¿«å–å¤±æ•ˆ

**`globalPassThroughEnv`**

- è¦å‚³éçµ¦æ‰€æœ‰ä»»å‹™çš„ç’°å¢ƒè®Šæ•¸
- å•Ÿç”¨åš´æ ¼ç’°å¢ƒè®Šæ•¸æ¨¡å¼

#### ä»»å‹™è¨­å®š

**`dependsOn`** - ä»»å‹™ä¾è³´

```json
{
  "build": {
    "dependsOn": ["^build"]
  }
}
```

- `^taskName`: **æ‹“æ’²ä¾è³´**,è¡¨ç¤ºæ‰€æœ‰ä¾è³´å¥—ä»¶çš„ `taskName` å¿…é ˆå…ˆå®Œæˆ
- `taskName`: åŒä¸€å¥—ä»¶å…§çš„ä»»å‹™ä¾è³´

**`outputs`** - è¼¸å‡ºæª”æ¡ˆ

```json
{
  "build": {
    "outputs": ["dist/**", ".next/**", "!.next/cache/**"]
  }
}
```

- æŒ‡å®šä»»å‹™ç”¢ç”Ÿçš„æª”æ¡ˆ,Turborepo æœƒå¿«å–é€™äº›æª”æ¡ˆ
- æ”¯æ´ glob æ¨¡å¼
- ä½¿ç”¨ `!` æ’é™¤ç‰¹å®šæª”æ¡ˆ
- **é‡è¦**: å¦‚æœæ²’æœ‰å®£å‘Š `outputs`,Turborepo ä¸æœƒå¿«å–ä»»ä½•æª”æ¡ˆ

**`inputs`** - è¼¸å…¥æª”æ¡ˆ

```json
{
  "test": {
    "inputs": ["src/**/*.ts", "test/**/*.ts", "tsconfig.json"]
  }
}
```

- å®šç¾©å½±éŸ¿ä»»å‹™å¿«å–é›œæ¹Šçš„æª”æ¡ˆ
- åªæœ‰é€™äº›æª”æ¡ˆè®Šæ›´æ™‚,ä»»å‹™æ‰æœƒé‡æ–°åŸ·è¡Œ
- æä¾›ç²¾ç¢ºçš„å¿«å–å¤±æ•ˆæ§åˆ¶

**`cache`** - å¿«å–æ§åˆ¶

```json
{
  "dev": {
    "cache": false
  }
}
```

- æ˜ç¢ºå•Ÿç”¨æˆ–åœç”¨ç‰¹å®šä»»å‹™çš„å¿«å–
- é–‹ç™¼ä¼ºæœå™¨ (`dev`) é€šå¸¸è¨­ç‚º `false`

**`env`** - ä»»å‹™ç‰¹å®šç’°å¢ƒè®Šæ•¸

```json
{
  "build": {
    "env": ["API_URL", "API_KEY"]
  }
}
```

- å½±éŸ¿ç‰¹å®šä»»å‹™å¿«å–é›œæ¹Šçš„ç’°å¢ƒè®Šæ•¸

**`outputMode`** - è¼¸å‡ºæ¨¡å¼

```json
{
  "build": {
    "outputMode": "new-only"
  }
}
```

- `full`: é¡¯ç¤ºæ‰€æœ‰è¼¸å‡º
- `new-only`: åªé¡¯ç¤ºæ–°çš„è¼¸å‡º
- `hash-only`: åªé¡¯ç¤ºé›œæ¹Š
- `errors-only`: åªé¡¯ç¤ºéŒ¯èª¤

---

## é‹ä½œæ–¹å¼

### 1. åŸ·è¡Œä»»å‹™

#### åŸºæœ¬ç”¨æ³•

```bash
# åŸ·è¡Œæ‰€æœ‰å¥—ä»¶çš„ build ä»»å‹™
turbo run build

# åŸ·è¡Œå¤šå€‹ä»»å‹™
turbo run build test lint

# åªåŸ·è¡Œç‰¹å®šå¥—ä»¶çš„ä»»å‹™
turbo run build --filter=web

# åŸ·è¡Œå—å½±éŸ¿çš„å¥—ä»¶
turbo run build --filter=[HEAD^1]
```

#### Filter èªæ³•

```bash
# åªåŸ·è¡Œ web å¥—ä»¶
--filter=web

# åŸ·è¡Œ web åŠå…¶ä¾è³´
--filter=web...

# åŸ·è¡Œä¾è³´ web çš„å¥—ä»¶
--filter=...web

# åŸ·è¡Œå¤šå€‹å¥—ä»¶
--filter={web,mobile}

# åŸºæ–¼ git è®Šæ›´
--filter=[HEAD^1]        # èˆ‡ä¸Šä¸€å€‹ commit æ¯”è¼ƒ
--filter=[main]          # èˆ‡ main åˆ†æ”¯æ¯”è¼ƒ
--filter=[origin/main]   # èˆ‡é ç«¯ main åˆ†æ”¯æ¯”è¼ƒ
```

### 2. ä»»å‹™åŸ·è¡Œæµç¨‹

```mermaid
flowchart TD
    A[turbo run build] --> B[è®€å– turbo.json]
    B --> C[å»ºç«‹ä¾è³´åœ–]
    C --> D[åˆ†æä»»å‹™ä¾è³´]
    D --> E[è¨ˆç®—æ¯å€‹ä»»å‹™çš„é›œæ¹Š]
    E --> F{æª¢æŸ¥å¿«å–}
    F -->|å‘½ä¸­| G[é‚„åŸå¿«å–è¼¸å‡º]
    F -->|æœªå‘½ä¸­| H[åŸ·è¡Œä»»å‹™]
    H --> I[å„²å­˜è¼¸å‡ºåˆ°å¿«å–]
    G --> J[æ¨™è¨˜ç‚ºå®Œæˆ]
    I --> J
    J --> K{é‚„æœ‰å¾…åŸ·è¡Œä»»å‹™?}
    K -->|æ˜¯| E
    K -->|å¦| L[å®Œæˆ]
```

### 3. é–‹ç™¼æ¨¡å¼

```bash
# å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨
turbo run dev

# ä½¿ç”¨ watch æ¨¡å¼
turbo run build --watch
```

**Watch æ¨¡å¼ç‰¹è‰²**:

- è‡ªå‹•åµæ¸¬æª”æ¡ˆè®Šæ›´
- ä¾è³´æ„ŸçŸ¥çš„ä»»å‹™é‡æ–°åŸ·è¡Œ
- åªé‡æ–°åŸ·è¡Œå—å½±éŸ¿çš„ä»»å‹™

### 4. å¿«å–ç®¡ç†

```bash
# æª¢è¦–å¿«å–ç‹€æ…‹
turbo run build --dry-run

# å¼·åˆ¶è·³éå¿«å–
turbo run build --force

# æ¸…é™¤æœ¬åœ°å¿«å–
rm -rf .turbo/cache
```

---

## é€²éšåŠŸèƒ½

### 1. é ç«¯å¿«å–è¨­å®š

#### ä½¿ç”¨ Vercel é ç«¯å¿«å– (å…è²»)

```bash
# ç™»å…¥
turbo login

# é€£çµå°ˆæ¡ˆ
turbo link
```

#### è‡ªè¨‚é ç«¯å¿«å–

å»ºç«‹ `.turbo/config.json`:

```json
{
  "apiurl": "https://your-cache-server.com",
  "token": "your-token",
  "teamid": "your-team-id"
}
```

æˆ–ä½¿ç”¨ç’°å¢ƒè®Šæ•¸:

```bash
export TURBO_API="https://your-cache-server.com"
export TURBO_TOKEN="your-token"
export TURBO_TEAM="your-team-id"
```

#### å¿«å–ç°½ç« é©—è­‰

åœ¨ `turbo.json` ä¸­å•Ÿç”¨:

```json
{
  "remoteCache": {
    "signature": true
  }
}
```

è¨­å®šç°½ç« é‡‘é‘°:

```bash
export TURBO_REMOTE_CACHE_SIGNATURE_KEY="your-secret-key"
```

### 2. Pruning (ä¿®å‰ª)

å»ºç«‹åªåŒ…å«ç‰¹å®šæ‡‰ç”¨ç¨‹å¼åŠå…¶ä¾è³´çš„å­é›†,ç”¨æ–¼éƒ¨ç½²:

```bash
# ä¿®å‰ªå‡º web æ‡‰ç”¨ç¨‹å¼
turbo prune --scope=web

# ç”¢ç”Ÿçš„çµæ§‹
out/
â”œâ”€â”€ package.json
â”œâ”€â”€ turbo.json
â”œâ”€â”€ apps/
â”‚   â””â”€â”€ web/
â””â”€â”€ packages/
    â””â”€â”€ ui/  # åªåŒ…å« web ä¾è³´çš„å¥—ä»¶
```

**ä½¿ç”¨å ´æ™¯**:

- Docker å¤šéšæ®µå»ºç½®
- æ¸›å°‘éƒ¨ç½²å¤§å°
- åŠ é€Ÿ CI/CD

### 3. è¦–è¦ºåŒ–ä¾è³´åœ–

```bash
# ç”¢ç”Ÿä¾è³´åœ–
turbo run build --graph

# ç”¢ç”Ÿ DOT æ ¼å¼
turbo run build --graph=graph.dot

# ä½¿ç”¨ Graphviz è¦–è¦ºåŒ–
dot -Tpng graph.dot -o graph.png
```

### 4. äº’å‹•å¼ä»»å‹™

Turborepo 2.0+ æ”¯æ´äº’å‹•å¼ä»»å‹™:

```json
{
  "tasks": {
    "test:interactive": {
      "interactive": true
    }
  }
}
```

å…è¨±ä½ é€²å…¥ç‰¹å®šä»»å‹™çš„ shell,å‚³éè¼¸å…¥ã€‚

### 5. å¥—ä»¶å±¤ç´šè¨­å®š

åœ¨å€‹åˆ¥å¥—ä»¶ä¸­å»ºç«‹ `turbo.json`:

```json
{
  "extends": ["//"],
  "tasks": {
    "build": {
      "outputs": ["custom-dist/**"]
    }
  }
}
```

---

## æ•ˆèƒ½æœ€ä½³åŒ–å»ºè­°

### 1. ç²¾ç¢ºå®šç¾© inputs å’Œ outputs

```json
{
  "build": {
    "inputs": ["src/**", "package.json", "tsconfig.json"],
    "outputs": ["dist/**"]
  }
}
```

### 2. ä½¿ç”¨é ç«¯å¿«å–

- åœ˜éšŠå…±äº«å¿«å–å¯ç¯€çœ 50-90% çš„å»ºç½®æ™‚é–“
- CI/CD ç’°å¢ƒç‰¹åˆ¥å—ç›Š

### 3. åˆç†è¨­å®š dependsOn

```json
{
  "test": {
    "dependsOn": ["^build"] // åªä¾è³´ä¾è³´å¥—ä»¶çš„ build
  },
  "lint": {
    "dependsOn": [] // ä¸ä¾è³´å…¶ä»–ä»»å‹™,å¯å¹³è¡ŒåŸ·è¡Œ
  }
}
```

### 4. æ’é™¤ä¸å¿…è¦çš„æª”æ¡ˆ

```json
{
  "build": {
    "outputs": [
      "dist/**",
      "!dist/**/*.map" // æ’é™¤ source map
    ]
  }
}
```

### 5. ä½¿ç”¨ --filter æ¸›å°‘åŸ·è¡Œç¯„åœ

```bash
# åªå»ºç½®è®Šæ›´çš„å¥—ä»¶
turbo run build --filter=[HEAD^1]
```

---

## å¸¸è¦‹å•é¡Œ

### Q1: Turborepo èˆ‡ Nx çš„å·®ç•°?

**Turborepo**:

- æ›´è¼•é‡,é…ç½®ç°¡å–®
- å°ˆæ³¨æ–¼å¿«å–å’Œä»»å‹™åŸ·è¡Œ
- èˆ‡ç¾æœ‰å·¥å…·éˆæ•´åˆè‰¯å¥½
- é©åˆå·²æœ‰å»ºç½®å·¥å…·çš„å°ˆæ¡ˆ

**Nx**:

- åŠŸèƒ½æ›´è±å¯Œ
- å…§å»ºç¨‹å¼ç¢¼ç”¢ç”Ÿå™¨
- æ›´å¤šçš„å°ˆæ¡ˆæ¨¡æ¿
- é©åˆå¾é›¶é–‹å§‹çš„å°ˆæ¡ˆ

### Q2: å¿«å–æœƒä½”ç”¨å¤šå°‘ç©ºé–“?

- æœ¬åœ°å¿«å–é è¨­ç„¡é™åˆ¶
- å¯ä»¥å®šæœŸæ¸…ç† `.turbo/cache/`
- é ç«¯å¿«å–ç”±æœå‹™æä¾›å•†ç®¡ç†

### Q3: å¦‚ä½•é™¤éŒ¯å¿«å–å•é¡Œ?

```bash
# ä½¿ç”¨ --dry-run æª¢è¦–å¿«å–ç‹€æ…‹
turbo run build --dry-run

# ä½¿ç”¨ --force è·³éå¿«å–
turbo run build --force

# æª¢è¦–è©³ç´°æ—¥èªŒ
turbo run build --verbosity=2
```

### Q4: å¯ä»¥åœ¨é Monorepo å°ˆæ¡ˆä½¿ç”¨å—?

å¯ä»¥,ä½†æ•ˆç›Šè¼ƒå°ã€‚Turborepo çš„ä¸»è¦å„ªå‹¢åœ¨æ–¼ç®¡ç†å¤šå€‹ç›¸äº’ä¾è³´çš„å¥—ä»¶ã€‚

---

## ç¸½çµ

Turborepo é€éä»¥ä¸‹æ©Ÿåˆ¶å¤§å¹…æå‡ Monorepo çš„å»ºç½®æ•ˆèƒ½:

1. **æ™ºæ…§å¿«å–**: åŸºæ–¼å…§å®¹çš„å¿«å–æŒ‡ç´‹,æ°¸ä¸é‡è¤‡è¨ˆç®—
2. **é ç«¯å¿«å–**: åœ˜éšŠå’Œ CI/CD å…±äº«å»ºç½®æˆæœ
3. **å¹³è¡ŒåŸ·è¡Œ**: æœ€å¤§åŒ–åˆ©ç”¨ CPU è³‡æº
4. **å¢é‡å»ºç½®**: åªå»ºç½®è®Šæ›´çš„éƒ¨åˆ†
5. **ä¾è³´æ„ŸçŸ¥**: æ™ºæ…§çš„ä»»å‹™ç·¨æ’

é€™äº›ç‰¹æ€§çµåˆèµ·ä¾†,å¯ä»¥å°‡å»ºç½®æ™‚é–“å¾æ•¸ååˆ†é˜ç¸®çŸ­åˆ°æ•¸ç§’é˜,å¤§å¹…æå‡é–‹ç™¼é«”é©—å’Œ CI/CD æ•ˆç‡ã€‚

---

## åƒè€ƒè³‡æº

- [Turborepo å®˜æ–¹æ–‡ä»¶](https://turbo.build/repo/docs)
- [Turborepo GitHub](https://github.com/vercel/turbo)
- [Vercel é ç«¯å¿«å–](https://vercel.com/docs/monorepos/remote-caching)
