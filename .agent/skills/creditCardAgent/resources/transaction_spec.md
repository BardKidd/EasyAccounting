# Transaction API Specification

## 1. 轉帳行為 (Transfer Logic)

當使用者從 **帳戶 A** 轉帳 **$500** 到 **帳戶 B** 時：

### 資料庫紀錄 (DB Records)

- 應產生 **2 筆** 交易紀錄。
- **交易 1 (From A)**:
  - `accountId`: A
  - `targetAccountId`: B
  - `type`: `EXPENSE` (支出)
  - `amount`: 500
- **交易 2 (To B)**:
  - `accountId`: B
  - `targetAccountId`: A
  - `type`: `INCOME` (收入)
  - `amount`: 500
- **關聯性**: 兩筆交易透過 `linkId` 互相參照。

### 帳戶餘額 (Wallet Balance)

- **帳戶 A**: 餘額 **減少 500**。
- **帳戶 B**: 餘額 **增加 500**。

### 刪除連動 (Cascade Delete)

- **規則**: 若刪除其中一筆轉帳交易，**另一筆必須自動刪除**，以確保帳目一致性。
- **餘額還原**: 兩邊帳戶的餘額都必須「反向沖銷」回轉帳前的狀態。

---

## 2. 交易修改與餘額連動 (Update & Balance)

當使用者 **修改** 一筆過去的交易時：

### 餘額更新邏輯 (Revert & Apply)

1.  **Revert (沖銷)**: 先將 **原交易** 對餘額的影響「反向」扣回/加回。
    - 若原為支出 $100 -> 帳戶 +100。
    - 若原為收入 $100 -> 帳戶 -100。
2.  **Apply (套用)**: 再計算 **新交易** 對餘額的影響。
    - 若改為支出 $200 -> 帳戶 -200。
3.  **Result**: 只需更新該 Account 的最終 `balance` 欄位，不需重算中間所有歷史流水帳。

---

## 3. 交易刪除 (Delete)

- 刪除 **收入** 交易 -> 帳戶餘額 **扣回** 該金額。
- 刪除 **支出** 交易 -> 帳戶餘額 **加回** 該金額。
- 若為 **轉帳** 交易 -> 觸發 Cascade Delete (見第 1 點)。

---

## 4. 統計報表 (Summary)

### 篩選規則

- **日期範圍**: `startDate` 到 `endDate` (含頭尾)。
- **排除轉帳**: 統計收入/支出時，應排除轉帳交易。
  - 判斷方式: `linkId` 為 `null` 的即為一般收支，非轉帳。
